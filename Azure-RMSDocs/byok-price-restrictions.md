---
# required metadata

title: BYOK details - Azure Information Protection
description: Understand details and restrictions when you use customer-managed keys (known as "bring your own key", or BYOK) with Azure Information Protection.
author: batamig
ms.author: bagol
manager: rkarlin
ms.date: 06/15/2020
ms.topic: conceptual
ms.collection: M365-security-compliance
ms.service: information-protection
ms.assetid: f5930ed3-a6cf-4eac-b2ec-fcf63aa4e809

# optional metadata

#ROBOTS:
#audience:
#ms.devlang:
ms.subservice: kms
ms.reviewer: esaggese
ms.suite: ems
#ms.tgt_pltfrm:
ms.custom: admin

---

# Bring your own key (BYOK) details for Azure Information Protection

>*Applies to: [Azure Information Protection](https://azure.microsoft.com/pricing/details/information-protection), [Office 365](https://download.microsoft.com/download/E/C/F/ECF42E71-4EC0-48FF-AA00-577AC14D5B5C/Azure_Information_Protection_licensing_datasheet_EN-US.pdf)*

Organizations with an Azure Information Protection subscription can choose to configure their tenant with their own key, instead of a default key generated by Microsoft.

BYOK and [usage logging](log-analyze-usage.md) work seamlessly with applications that integrate with the Azure Rights Management service used by Azure Information Protection.

Supported applications include:

- **Cloud services,** such as Microsoft SharePoint and Office 365

- **On-premises services** running Exchange and SharePoint applications that use the Azure Rights Management service via the RMS connector

- **Client applications,** such as Office 2019, Office 2016, and Office 2013

## Azure Key Vault key storage

Customer-generated keys must be stored in the Azure Key Vault for BYOK protection. 

> [!NOTE]
> Using HSM-protected keys in the Azure Key Vault requires an [Azure Key Vault Premium service tier](https://azure.microsoft.com/pricing/details/key-vault/), which incurs an additional monthly subscription fee.

### Sharing key vaults and subscriptions

We recommend using a **dedicated key vault** for your tenant key. Dedicated key vaults help to ensure that calls by other services do not cause [service limits](/azure/key-vault/key-vault-service-limits) to be exceeded. Exceeding service limits on the key vault where your tenant key is stored may cause response time throttling for the Azure Rights Management service.

As different services have varying key management requirements, Microsoft also recommends using a **dedicated Azure subscription** for your key vault. Dedicated Azure subscriptions:

- Help safeguard against misconfigurations

- Are more secure when different services have different administrators

To share an Azure subscription with other services that use Azure Key Vault, make sure that the subscription shares a common set of administrators. Confirming that all administrators who use the subscription have a solid understanding of every key they can access, means they are less likely to misconfigure your keys.

**Example:** Using a shared Azure subscription when the administrators for your Azure Information Protection tenant key are the same individuals that administer your keys for Office 365 Customer Key and CRM online. If the key administrators for these services are different, we recommend using dedicated subscriptions.

### Benefits of using Azure Key Vault

Azure Key Vault provides a centralized and consistent key management solution for many cloud-based and on-premises services that use encryption. 


In addition to managing keys, Azure Key Vault offers your security administrators the same management experience to store, access, and manage certificates and secrets (such as passwords) for other services and applications that use encryption. 

Storing your tenant key in the Azure Key Vault provides the following advantages:

|Advantage  |Description  |
|---------|---------|
|**Built-in interfaces**| Azure Key Vault supports a number of built-in interfaces for key management, including PowerShell, CLI, REST APIs, and the Azure portal. </br></br>Other services and tools have integrated with Key Vault for optimized capabilities for specific tasks, such as monitoring. </br></br>For example, analyze your key usage logs with Operations Management Suite Log analytics, set alerts when specified criteria are met, and so on.        |
|**Role separation**| Azure Key Vault provides role separation as a recognized security best practice. </br></br>Role separation ensures that Azure Information Protection administrators can focus on their highest priorities, including managing data classification and protection, as well as encryption keys and policies for specific security or compliance requirements. |
|**Master key location**| Azure Key Vault is available in a variety of locations, and supports organizations with restrictions where master keys can live. </br></br>For more information, see the [Products available by region](https://azure.microsoft.com/regions/services/) page on the Azure site.|
|**Separated security domains**|Azure Key Vault uses separate security domains for its data centers in regions such as North America, EMEA (Europe, Middle East and Africa), and Asia. </br></br>Azure Key Vault also uses different instances of Azure, such as Microsoft Azure Germany, and Azure Government. |
|**Unified experience**| Azure Key Vault also enables security administrators to store, access, and manage certificates and secrets, such as passwords, for other services that use encryption. </br></br>Using Azure Key Vault for your tenant keys provides a seamless user experience for administrators who manage all of these elements.|

For the latest updates and to learn how other services use [Azure Key Vault?](/azure/key-vault/key-vault-whatis), visit the [Azure Key Vault team blog](https://blogs.technet.microsoft.com/kv/).
    
## Usage logging for BYOK

Usage logs are generated by every application that makes requests to the Azure Rights Management service.

For more details about key usage logging for BYOK, see [Logging and analyzing the protection usage from Azure Information Protection](log-analyze-usage.md).

Although it’s optional, you'll probably also want to use the near real-time usage logs from Azure Information Protection to see exactly how and when your tenant key is being used. 

For additional assurance, Azure Information Protection usage logging can be cross referenced with [Azure Key Vault logging](/azure/key-vault/key-vault-logging). Key Vault logs provide a reliable method to independently monitor that your key is only used by Azure Rights Management service. If necessary, immediately revoke access to your key by removing permissions on the key vault.

## Options for creating and storing your key
Options to create and store your own key:

- **Managed by you (BYOK)**: For complete control over your tenant key, use BYOK [Azure Key Vault](https://azure.microsoft.com/services/key-vault/) with Azure Information Protection. In the BYOK scenario, you create your key either directly in Key Vault, or you create it on-premises. If you create the key on-premises, you'll then transfer or import that key into Key Vault. Azure Information Protection is used to configure usage of this key, and Azure Key Vault is used to maintain and manage it.

### Create on-premises key

- **Create an on-premises key and transfer or import to Key Vault:**:
    
    - HSM-protected key created on-premises and transferred to Key Vault as an HSM-protected key.
    
    - A software-protected key that you create on-premises, convert, and then transfer to Key Vault as an HSM-protected key. This option is supported only when you [migrate from Active Directory Rights Management Services (AD RMS)](migrate-from-ad-rms-to-azure-rms.md).
    
    - A software-protected key that you create on-premises and import to Key Vault as a software-protected key. This option requires a .PFX certificate file.

Of these BYOK options, the most typical is an HSM-protected key that you create on-premises and transfer to Key Vault as an HSM-protected key. Although this option has the greatest administrative overheads, it might be required for your organization to comply with specific regulations. The HSMs that are used by Azure Key Vault are FIPS 140-2 Level 2 validated.

With this option, the following happens:

1. You generate your tenant key on your premises, in line with your IT policies and security policies. This key is the master copy. It remains on-premises and you are responsible for backing it up.

2. You create a copy of this key, and securely transfer this copy from your HSM to Azure Key Vault. Throughout this process, the master copy of this key never leaves the hardware protection boundary.

3. The copy of the key is protected by Azure Key Vault.

### Creating your key in Azure Key Vault
    
- **A key that you create in Key Vault**:
    
    - An HSM-protected key that you create in Key Vault.
    
    - A software-protected key that you create in Key Vault.

## Exporting your trusted publishing domain

When you use BYOK for your Azure Information Protection tenant key, you can't export your trusted publishing domain (TPD). The TPD is needed if you decide to no longer use Azure Information Protection but must still be able to decrypt content that was protected by Azure Information Protection. To prepare for this scenario by creating a suitable TPD ahead of time, see the following instructions [How to prepare an Azure Information Protection "Cloud Exit" plan](https://techcommunity.microsoft.com/t5/Azure-Information-Protection/How-to-prepare-an-Azure-Information-Protection-Cloud-Exit-plan/ba-p/382631).

## Implementing BYOK for your Azure Information Protection tenant key

Use the information and procedures in this section if you have decided to generate and manage your tenant key; the bring your own key (BYOK) scenario:

> [!NOTE]
> If you have started to use Azure Information Protection with a tenant key that is managed by Microsoft and you now want to manage your tenant key (move to BYOK), your previously protected documents and emails will remain accessible by using an archived key. 

### Prerequisites for BYOK
See the following table for a list of prerequisites for bring your own key (BYOK).

|Requirement|More information|
|---------------|--------------------|
|Your Azure Information Protection tenant must have an Azure subscription. If you do not have one, you can sign up for a [free account](https://azure.microsoft.com/pricing/free-trial/). <br /><br /> To use an HSM-protected key, you must have the Azure Key Vault Premium service tier.|The free Azure subscription that provides access to configure Azure Active Directory and configuration of Azure Rights Management custom templates (**Access to Azure Active Directory**) is not sufficient to use Azure Key Vault. To confirm that you have an Azure subscription that you can use for BYOK, use [Azure PowerShell](/powershell/azure/overview) cmdlets: <br /><br /> 1. Start an Azure PowerShell session with the **Run as administrator** option, and sign in as a global admin for your Azure Information Protection tenant by using `Connect-AzAccount` and then copy and paste the resulting token string into `https://microsoft.com/devicelogin`by using a browser. <br /><br /> For more information, see [Sign in with Azure PowerShell](/powershell/azure/authenticate-azureps). <br /><br />2. Type the following and confirm that you see values displayed for your subscription name and ID, your Azure Information Protection tenant ID, and that the state is enabled: `Get-AzSubscription`<br /><br />If no values are displayed and you are just returned to the prompt, you do not have an Azure subscription that can be used for BYOK. <br /><br />**Note**: In addition to the BYOK prerequisites, if you are migrating from AD RMS to Azure Information Protection by using software key to hardware key, you must have a minimum version of 11.62 if you are using Thales firmware for your HSM.|
|To use an HSM-protected key that you create on-premises: <br /><br />- All the prerequisites listed for Key Vault BYOK. |See [Prerequisites for BYOK](/azure/key-vault/key-vault-hsm-protected-keys#prerequisites-for-byok) from the Azure Key Vault documentation. <br /><br /> **Note**: In addition to the BYOK prerequisites, if you are migrating from AD RMS to Azure Information Protection by using software key to hardware key, you must have a minimum version of 11.62 if you are using Thales firmware for your HSM.|
|If the key vault to contain your tenant key uses Virtual Network Service Endpoints for Azure Key Vault: <br /><br />- Allow trusted Microsoft services to bypass this firewall.|For more information, see [Virtual Network Service Endpoints for Azure Key Vault](/azure/key-vault/key-vault-overview-vnet-service-endpoints).|
|The AIPService PowerShell module for Azure Information Protection.|For installation instructions, see [Installing the AIPService PowerShell module](./install-powershell.md).|

For more information about nCipher nShield hardware security module (HSM) and how they are used with Azure Key Vault, see the [nCipher website](https://www.ncipher.com/products/key-management/cloud-microsoft-azure/how-to-buy).

### Choosing your key vault location

When you create a key vault to contain the key to be used as your tenant key for Azure Information, you must specify a location. This location is an Azure region, or Azure instance.

Make your choice first for compliance, and then to minimize network latency:

- If you have chosen the BYOK key topology for compliance reasons, those compliance requirements might mandate the Azure region or Azure instance that stores your Azure Information Protection tenant key.

- Because all cryptographic calls for protection chain to your Azure Information Protection tenant key, you want to minimize the network latency that these calls incur. To do that, create your key vault in the same Azure region or instance as your Azure Information Protection tenant.

To identify the location of your Azure Information Protection tenant, use the [Get-AipServiceConfiguration](/powershell/module/aipservice/get-aipserviceconfiguration)​ PowerShell cmdlet and identify the region from the URLs. For example:

```ps
LicensingIntranetDistributionPointUrl : https://5c6bb73b-1038-4eec-863d-49bded473437.rms.na.aadrm.com/_wmcs/licensing
```

The region is identifiable from **rms.na.aadrm.com**, and for this example, it is in North America.

Use the following table to identify which Azure region or instance is recommended to minimize network latency.

|Azure region or instance|Recommended location for your key vault|
|---------------|--------------------|
|rms.**na**.aadrm.com|**North Central US** or **East US**|
|rms.**eu**.aadrm.com|**North Europe** or **West Europe**|
|rms.**ap**.aadrm.com​|**East Asia** or **Southeast Asia**|
|rms.**sa**.aadrm.com|**West US** or **East US**|
|rms.**govus**.aadrm.com​|**Central US** or **East US 2**|
|rms.**aadrm.us**|**US Gov Virginia** or **US Gov Arizona**|
|rms.**aadrm.cn**|**China East 2** or **China North 2**|


### Instructions for BYOK

Use the Azure Key Vault documentation to create a key vault and the key that you want to use for Azure Information Protection. For example, see [Get started with Azure Key Vault](/azure/key-vault/key-vault-get-started).

Make sure that the key length is 2048 bits (recommended) or 1024 bits. Other key lengths are not supported by Azure Information Protection. 

Don't use a 1024-bit key as your active tenant key because it is considered to offer an inadequate level of protection. Microsoft doesn’t endorse the use of lower key lengths such as 1024-bit RSA keys and the associated use of protocols that offer inadequate levels of protection, such as SHA-1. We recommend moving to a higher key length.

To create an HSM-protected key on-premises and transfer it to your key vault as an HSM-protected key, follow the procedures in [How to generate and transfer HSM-protected keys for Azure Key Vault](/azure/key-vault/key-vault-hsm-protected-keys).

For Azure Information Protection to use the key, all Key Vault operations must be permitted for the key. This is the default configuration and the operations are encrypt, decrypt, wrapKey, unwrapKey, sign, and verify. You can check the permitted operations of a key by using the following PowerShell command: `(Get-AzKeyVaultKey -VaultName <key vault name> -Name <key name>).Attributes.KeyOps`. If necessary, add permitted operations by using [Update-AzKeyVaultKey](/powershell/module/az.keyvault/update-azkeyvaultkey) and the *KeyOps* parameter.

A key that is stored in Key Vault has a key ID. This key ID is a URL that contains the name of the key vault, the keys container, the name of the key, and the key version. For example: **https://contosorms-kv.vault.azure.net/keys/contosorms-byok/aaaabbbbcccc111122223333**. You must configure Azure Information Protection to use this key, by specifying its key vault URL.

Before Azure Information Protection can use the key, the Azure Rights Management service must be authorized to use the key in your organization's key vault. To do this, the Azure Key Vault administrator can use the Azure portal, or Azure PowerShell:

Configuration by using the Azure portal:

1. Navigate to **Key vaults** > **\<*your key vault name*>** > **Access policies** > **Add new**.

2. From the **Add access policy** pane, select **Azure Information Protection BYOK** from the **Configure from template (optional)** list box, and click **OK**.
    
    The selected template has the following configuration:
    
    - **Microsoft Rights Management Services** is automatically assigned for **Select principal**.
    - **Get**, **Decrypt**, and **Sign** is automatically selected for the key permissions. 

Configuration by using PowerShell:

- Run the Key Vault PowerShell cmdlet, [Set-AzKeyVaultAccessPolicy](/powershell/module/az.keyvault/set-azkeyvaultaccesspolicy), and grant permissions to the Azure Rights Management service principal, by using the GUID **00000012-0000-0000-c000-000000000000**. For example:

    ```ps
    Set-AzKeyVaultAccessPolicy -VaultName 'ContosoRMS-kv' -ResourceGroupName 'ContosoRMS-byok-rg' -ServicePrincipalName 00000012-0000-0000-c000-000000000000 -PermissionsToKeys decrypt,sign,get
    ```

You're now ready to configure Azure Information Protection to use this key as your organization's Azure Information Protection tenant key. Using Azure RMS cmdlets, first connect to the Azure Rights Management service and sign in:

```ps
Connect-AipService
```

Then run the [Use-AipServiceKeyVaultKey cmdlet](/powershell/module/aipservice/use-aipservicekeyvaultkey), specifying the key URL. For example:

```ps
Use-AipServiceKeyVaultKey -KeyVaultKeyUrl "https://contosorms-kv.vault.azure.net/keys/contosorms-byok/aaaabbbbcccc111122223333"
```

> [!IMPORTANT]
> In this example, "aaaabbbbcccc111122223333" is the version of the key to use. If you do not specify the version, the current version of the key is used without warning and the command appears to work. However, if your key in Key Vault is later updated (renewed), the Azure Rights Management service will stop working for your tenant, even if you run the Use-AipServiceKeyVaultKey command again.
> 
> Make sure that you specify the key version, in addition to the key name when you run this command. You can use the Azure Key Vault cmd, [Get-AzKeyVaultKey](/powershell/module/az.keyvault/get-azkeyvaultkey), to get the version number of the current key. For example: `Get-AzKeyVaultKey -VaultName 'contosorms-kv' -KeyName 'contosorms-byok'`

If you need to confirm that the key URL is set correctly for Azure Information Protection: In Azure Key Vault, run [Get-AzKeyVaultKey](/powershell/module/az.keyvault/get-azkeyvaultkey) to see the key URL.

Finally, if the Azure Rights Management service is already activated, run [Set-AipServiceKeyProperties](/powershell/module/aipservice/set-aipservicekeyproperties) to tell Azure Information Protection to use this key as the active tenant key for the Azure Rights Management service. If you do not do this step, Azure Information Protection will continue to use the default Microsoft-managed key that was automatically created for your tenant.